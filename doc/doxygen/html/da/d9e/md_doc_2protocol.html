<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RTypeuh: R-Type communication protocol</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript" src="../../darkmode_toggle.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">RTypeuh
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('da/d9e/md_doc_2protocol.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">R-Type communication protocol</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a> This document describes the communication protocol between the R-Type server and the R-Type client.</p>
<p>The protocol is heavily <a href="https://en.wikipedia.org/wiki/Entity_component_system">ECS</a>-oriented in the sense that all info sent by the server to the client are entity creation/deletion, components being attached to entities, and components' internal state being updated. It is true that on the other hand, client-to-server communication is not as much ECS-oriented as its counterpart, that is because the client doesn't decide anything about the <a class="el" href="../../d8/d14/namespaceECS.html">ECS</a>. It does, however, communicate player input to the server.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
General information</h1>
<p>No matter the platform, communication is always made through UDP sockets, for faster data transfer than TCP.</p>
<p>The protocol is binary, meaning that &ndash; contrary to text protocols &ndash; the data sent is not human-readable, it is some form of bytecode. This specific bytecode's styntax is detailed in this document.</p>
<p>Integers types are sent as in network byte order, i.e. big endian. See <a href="https://linux.die.net/man/3/endian"><code>man 3 endian</code></a> or <a href="https://linux.die.net/man/3/byteorder"><code>man 3 byteorder</code></a> if you have no idea what the previous sentence is about.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Protocol specification</h1>
<p>Below are described both the server-to-client and the client-to-server communication protocols</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Connection initialisation</h2>
<p>When establishing connection between the client and the server, some initialisation process is required to make sure the client knows about all components used by the server, and this process also allows optimisation of the in-game protocol.</p>
<h3><a class="anchor" id="autotoc_md4"></a>
Description</h3>
<p>When the client connects to the server, the server will first send to the client the number of components that can be used during the game on 2 bytes (big endian <code>uint16_t</code>) and the maximum length of a component's name on 1 byte. Then, the names of all components that may be used during the game are transmitted one by one, as described below. Once all the names are transmitted, a special 2-bytes end indicator (<code>0xffff</code>) will be sent so that the client can make sure it received correct data.</p>
<blockquote class="doxtable">
<p>&zwj;<em>Note</em>: The server may send a maximum length that is actually greater than the length of the longest component name (to align with a power of 2 for example) </p>
</blockquote>
<p>The names of components are sent one after the other, zero-padded to fit the maximum length of a component's name, without any separator. See the example below.</p>
<p>The names may only be composed of one or more of the following ascii characters:</p>
<ul>
<li>All letters &lsquo;'a&rsquo;<code>to</code>'z'<code>and</code>'A'<code>to</code>'Z'<code></code></li>
<li><code>All digits</code>'0'<code>through</code>'9'<code></code></li>
<li><code>The dash character</code>'-'<code></code></li>
<li><code>The underscore character</code>'_'<code></code></li>
<li><code>The dot character</code>'.'`</li>
</ul>
<p>Meaning they all match the regular expression <code>[a-zA-Z0-9\-_.]+</code></p>
<p>The order the names are sent in matters: their position (starting from 0) will be used as the <code>component_id</code> in later communications.</p>
<h3><a class="anchor" id="autotoc_md5"></a>
Example</h3>
<p>For example, if the only components used are <code>"Position"</code>, <code>"Velocity"</code> and <code>"Health"</code>, the server could decide on 8 to be the maximum name length, and would then proceed to send the following to any incoming clients, in order:</p>
<ul>
<li>The bytes <code>0x0003</code>: the number of components used as a big endian 16-bits unsigned integer</li>
<li>The byte <code>0x08</code>: the maximum length of a component name as an 8-bits unsigned integer</li>
<li>The string <code>"Position"</code> (bytes <code>0x506f736974696f6e</code>)</li>
<li>The string <code>"Velocity"</code> (bytes <code>0x56656c6f63697479</code>)</li>
<li>The string <code>"Health"</code>, followed by 2 padding zero bytes to align with the maximum name length (bytes <code>0x4865616c74680000</code>)</li>
<li>The bytes <code>0xffff</code>: the indicator sequence of the end of the initialisation process.</li>
</ul>
<h3><a class="anchor" id="autotoc_md6"></a>
Design choices</h3>
<p>This initialisation process's main purpose is to allow the client to make sure it knows about all the components that will be used by the server during the game.</p>
<p>This purpose is achievable in many different ways; this specific protocol aims at optimising the communication after the initialisation is done, and allowing the client to make sure it received everything properly.</p>
<p>For example, one way of sending component names would have been to send them concatenated with spaces or line breaks without specifying the count of names sent nor the length of the names. The main advantage of proceeding this way is that it is the most bandwidth-efficient way of communicating names (excluding methods which involve compression algorithms). On the other hand, it provides no ways for the client to check if any network errors occured. Plus, processing the names can be more CPU-expensive since they are not aligned in any way but rather separated by a delimiter character.</p>
<p>In contrary, our R-Type protocol gives the client many ways to make sure they received everything properly: since the number and size of the names are sent first, the client can then read <code>size * count</code> bytes from the server, then read the end of initialisation sequence to make sure the correct number of bytes have been received. On top of that, the fact that the names are aligned allows the client to use a more performant algorithm to read names than if they were delimiter-separated.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Server-to-client protocol</h2>
<p>The server informs the client about all <a class="el" href="../../d8/d14/namespaceECS.html">ECS</a> updates, which includes:</p>
<ul>
<li>Entity creation</li>
<li>Entity deletion</li>
<li><a class="el" href="../../d9/d12/namespaceComponents.html">Components</a> getting attached to entities</li>
<li><a class="el" href="../../d9/d12/namespaceComponents.html">Components</a>' internal state being updated</li>
<li><a class="el" href="../../d9/d12/namespaceComponents.html">Components</a> getting detached from entities.</li>
</ul>
<p>This way, the server only notifies of updates instead of dumping all info of all entities each frame.</p>
<h3><a class="anchor" id="autotoc_md8"></a>
General bytecode syntax</h3>
<p>The server-to-client communication consists in a stream of instructions formed by the server that the client must interpret to update its copy of the <a class="el" href="../../d8/d14/namespaceECS.html">ECS</a>.</p>
<p>Those instructions are identified by an <a href="https://en.wikipedia.org/wiki/Opcode">opcode</a>, followed by instruction-specific operands.</p>
<p>The protocol is designed in a way that allows the client to know for sure the number of bytes of each instruction either directly from the opcode or from the opcode and following operands, depending on each specific instruction.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Instruction set</h3>
<h4><a class="anchor" id="autotoc_md10"></a>
Instruction table</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Instruction   </th><th class="markdownTableHeadNone">Opcode   </th><th class="markdownTableHeadNone">Operands   </th><th class="markdownTableHeadNone">Instruction size    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Create entity   </td><td class="markdownTableBodyNone">0x0   </td><td class="markdownTableBodyNone"><code>entity_id</code>   </td><td class="markdownTableBodyNone">3    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Delete entity   </td><td class="markdownTableBodyNone">0x1   </td><td class="markdownTableBodyNone"><code>entity_id</code>   </td><td class="markdownTableBodyNone">3    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Attach component   </td><td class="markdownTableBodyNone">0x2   </td><td class="markdownTableBodyNone"><code>entity_id</code>, <code>component_id</code>   </td><td class="markdownTableBodyNone">5    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Update component   </td><td class="markdownTableBodyNone">0x3   </td><td class="markdownTableBodyNone"><code>entity_id</code>, <code>component_id</code>, <code>component_data</code>   </td><td class="markdownTableBodyNone">5 + <code>data_size</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Detach component   </td><td class="markdownTableBodyNone">0x4   </td><td class="markdownTableBodyNone"><code>entity_id</code>, <code>component_id</code>   </td><td class="markdownTableBodyNone">5   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md11"></a>
Operand sizes and format</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Operand   </th><th class="markdownTableHeadNone">Size   </th><th class="markdownTableHeadNone">Type    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">entity_id   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">unsigned integer    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">component_id   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">unsigned integer    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">component_data   </td><td class="markdownTableBodyNone">component-specific   </td><td class="markdownTableBodyNone">component-specific   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md12"></a>
Detail</h4>
<h5>0x0 - Create entity</h5>
<p>This instruction informs the client that an entity has been created, with no components attached. This entity will later be referred to by its <code>entity_id</code> by the server, the operand of this instruction.</p>
<h5>0x1 - Delete entity</h5>
<p>This instruction informs the client that an entity is deleted from the <a class="el" href="../../d8/d14/namespaceECS.html">ECS</a>. The deleted entity can be identified by the instruction's operand, the <code>entity_id</code>.</p>
<h5>0x2 - Attach component</h5>
<p>This instruction informs the client that a specific component has been attached to an entity, with its defaults parameters. The first operand is the id of the entity to which the component is attached. The second operand is the id of the component being attached.</p>
<h5>0x3 - Update component</h5>
<p>This instruction informs the client about the update of a specific component attached to a specific entity. The entity is identified by the first operand, the component, by the second.</p>
<p>This instruction is specific in that its size depends on the component, which is one of its operands. The size of the third operand is specific to each component, which is part of why the initialisation process is required to make sure the client knows about all the used components.</p>
<p>Since the component serialisation is defined by each component, all the server and the client can do is check that the number of bytes processed is correct; it is the component's implementation's responsibility to transfer its state properly over the network.</p>
<h5>0x4 Detach component</h5>
<p>This instruction informs the client about a specific component getting detached from an entity. The involved entity is identified by the first operand; the involved component is identified by the second operand.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Client-to-server protocol</h2>
<p>The client-to-server protocol is much less elaborate than its counterpart, since there is no <a class="el" href="../../d8/d14/namespaceECS.html">ECS</a> involved.</p>
<p>The client informs the server about all user input, in the form of key up / key down events. Similarly to the server-to-client protocol, the communication is done through an instruction-based stream of bytes, where each instruction has its specific operands.</p>
<blockquote class="doxtable">
<p>&zwj;<em>Note:</em> The current instruction set doesn't use operands with any instruction; this is to come in later updates of the protocol (namely for click position) </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md14"></a>
Instruction set</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Instruction   </th><th class="markdownTableHeadNone">Opcode   </th><th class="markdownTableHeadNone">Operands   </th><th class="markdownTableHeadNone">Instruction size    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Right key pressed   </td><td class="markdownTableBodyNone">0x0   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Right key released   </td><td class="markdownTableBodyNone">0x1   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Up key pressed   </td><td class="markdownTableBodyNone">0x2   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Up key released   </td><td class="markdownTableBodyNone">0x3   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Left key pressed   </td><td class="markdownTableBodyNone">0x4   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Left key released   </td><td class="markdownTableBodyNone">0x5   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Down key pressed   </td><td class="markdownTableBodyNone">0x6   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Down key released   </td><td class="markdownTableBodyNone">0x7   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Left click pressed   </td><td class="markdownTableBodyNone">0x8   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Left click released   </td><td class="markdownTableBodyNone">0x9   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Right click pressed   </td><td class="markdownTableBodyNone">0xa   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Right click released   </td><td class="markdownTableBodyNone">0xb   </td><td class="markdownTableBodyNone"><em>none</em>   </td><td class="markdownTableBodyNone">1   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md15"></a>
Version</h1>
<p>R-Typeuh network protocol version 0.1.0, 21/09/2024, written by Florent Charpentier, reviewed by the R-Typeuh team </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
